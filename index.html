<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIVE QUINTAY SPA - VERIFICADOR</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A2F4F">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        body {
            background-color: #0A2F4F;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h2 { color: #00E0D0; margin-bottom: 5px; letter-spacing: 2px; }
        .status { background: #0D3B5C; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; }
        input[type="text"] {
            width: 100%; box-sizing: border-box; padding: 18px; font-size: 1.5rem;
            border-radius: 12px; border: 2px solid #00E0D0; text-align: center;
            text-transform: uppercase; background: #fdfdfd; color: #333;
        }
        button { width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: bold; font-size: 2.2rem; margin-top: 15px; cursor: pointer; }
        #verificar-manual { background: #2196F3; color: white; }
        #btn-total-pendientes { background: #FF9800; color: white; margin-top: 10px; font-size: 1.8rem; border: 2px solid #CC7A00; }

        /* CAPA PANTALLA COMPLETA (OCULTA POR DEFECTO) */
        #flash-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #00C853;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .flash-check { font-size: 200px; animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Estilos Tarjetas Lista */
        .card-pendiente {
            background: #0D3B5C; border-left: 5px solid #FF6B35; margin: 10px 0;
            padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .txt-patente-lista { color: #00E0D0; font-size: 1.4rem; font-weight: bold; }
        .txt-hora-lista { color: #B0BEC5; font-size: 0.9rem; }
        .badge-pendiente { background: #FF6B35; color: white; padding: 5px 10px; border-radius: 6px; font-weight: bold; }
        hr { border: 0.5px solid #0D3B5C; margin: 30px 0; }
    </style>
</head>
<body>

    <div id="flash-overlay">
        <div class="flash-check">✅</div>
        <h1 style="color: white; font-size: 3rem;">PAGADO</h1>
    </div>

    <div style="margin-bottom: 30px;">
        <h2>VIVE QUINTAY SPA</h2>
        <span class="status">VERIFICACIÓN DE PATENTES</span>
    </div>

    <div style="margin-bottom: 20px;">
        <input type="text" id="inputPatente" placeholder="BUSCAR PATENTE" autocomplete="off" />
        <button id="verificar-manual" onclick="verificarPatente()">VERIFICAR</button>
        <button id="btn-total-pendientes" onclick="verTotalPendientes()">TOTAL PENDIENTES</button>
    </div>

    <hr>
    <div id="display-resultado"></div>
    <div id="lista-pendientes"></div>

    <div id="registro-container" style="display:none; background: #0D3B5C; padding: 25px; border-radius: 20px; border: 2px solid #FF6B35; margin-top: 20px;">
        <p style="margin: 0 0 15px 0; color: #FFB300; font-weight: bold;">NO REGISTRADO</p>
        <input type="text" id="patenteNueva" style="text-transform: uppercase; font-weight: bold;" />
        <button onclick="accionRegistrar()" style="background: #FF6B35; color: white;">REGISTRAR INGRESO POR MINUTO</button>
    </div>

    <script>
        const firebaseConfig = {
            projectId: "vive-quintay-spa",
            authDomain: "vive-quintay-spa.firebaseapp.com",
            storageBucket: "vive-quintay-spa.appspot.com",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function verificarPatente() {
            const rawInput = document.getElementById("inputPatente").value.toUpperCase().trim();
            const patente = rawInput.replace(/-/g, "").replace(/\s+/g, "");
            const display = document.getElementById("display-resultado");
            const flash = document.getElementById("flash-overlay");
            const regContainer = document.getElementById("registro-container");
            const listaDiv = document.getElementById("lista-pendientes");
            
            listaDiv.innerHTML = "";
            if (!patente) { display.innerHTML = "<p style='color: #FFB300;'>Ingresa una patente</p>"; return; }

            try {
                const doc = await db.collection("activos").doc(patente).get();
                if (doc.exists) {
                    const data = doc.data();
                    regContainer.style.display = "none";
                    
                    if (data.tipo === "Ticket por Minuto") {
                        display.innerHTML = `
                            <div style="background: #FF9800; color: black; padding: 25px; border-radius: 15px; border: 4px solid #CC7A00;">
                                <h1 style="margin:0; font-size: 2rem;">PENDIENTE</h1>
                                <h2 style="margin:5px 0; font-size: 1.4rem;">TICKET MINUTO</h2>
                                <p style="font-weight: bold; margin: 10px 0 0 0;">Ingreso: ${data.hora || 'No disponible'}</p>
                            </div>`;
                    } else {
                        // 1. MOSTRAR EL FLASH PANTALLA COMPLETA
                        flash.style.display = "flex";
                        
                        // 2. MOSTRAR LOS DETALLES DE FONDO (lo que quedará después)
                        display.innerHTML = `
                            <div style="background: #00C853; color: white; padding: 25px; border-radius: 15px; border: 4px solid white;">
                                <h1 style="margin:0; font-size: 2rem;">PAGADO</h1>
                                <h2 style="margin:5px 0; font-size: 1.4rem;">PASE DIARIO</h2>
                                <p style="font-weight: bold; margin: 10px 0 0 0;">Ingreso: ${data.hora || 'No disponible'}</p>
                            </div>`;

                        // 3. QUITAR EL FLASH DESPUÉS DE 1.5 SEGUNDOS
                        setTimeout(() => {
                            flash.style.opacity = "0";
                            flash.style.transition = "opacity 0.5s ease";
                            setTimeout(() => {
                                flash.style.display = "none";
                                flash.style.opacity = "1"; // Reset para la próxima vez
                            }, 500);
                        }, 1500);
                    }
                } else {
                    display.innerHTML = `<h1 style="color: #D32F2F;">NO REGISTRADO</h1>`;
                    regContainer.style.display = "block";
                    document.getElementById("patenteNueva").value = patente;
                }
            } catch (e) {
                display.innerHTML = "<p style='color: #D32F2F;'>Error de conexión.</p>";
            }
        }

        async function verTotalPendientes() {
            const listaDiv = document.getElementById("lista-pendientes");
            const display = document.getElementById("display-resultado");
            document.getElementById("registro-container").style.display = "none";
            display.innerHTML = "";
            listaDiv.innerHTML = "<p style='color: #00E0D0;'>Consultando patio...</p>";
            try {
                const snapshot = await db.collection("activos").where("tipo", "==", "Ticket por Minuto").get();
                if (snapshot.empty) { listaDiv.innerHTML = "<p style='color: #FFB300; margin-top:20px;'>NO HAY PENDIENTES</p>"; return; }
                let html = `<h3 style="color: #00E0D0; margin-bottom: 15px;">TOTAL PENDIENTES: ${snapshot.size}</h3>`;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `<div class="card-pendiente" onclick="seleccionarPatente('${doc.id}')">
                                <div style="text-align: left;">
                                    <span class="txt-patente-lista">${doc.id}</span>
                                    <span class="txt-hora-lista">Ingreso: ${data.hora || '--:--'}</span>
                                </div>
                                <div class="badge-pendiente">PENDIENTE</div>
                             </div>`;
                });
                listaDiv.innerHTML = html;
                listaDiv.scrollIntoView({ behavior: 'smooth' });
            } catch (e) { listaDiv.innerHTML = "<p style='color: #D32F2F;'>Error de conexión.</p>"; }
        }

        function seleccionarPatente(p) {
            document.getElementById("inputPatente").value = p;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            verificarPatente();
        }

        async function accionRegistrar() {
            const patente = document.getElementById("patenteNueva").value.toUpperCase().trim();
            if (!patente) return;
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-CL');
            const fecha = ahora.toLocaleDateString('es-CL');
            try {
                await db.collection("activos").doc(patente).set({ patente, tipo: "Ticket por Minuto", hora, fecha, status: "Activo" });
                document.getElementById("registro-container").style.display = "none";
                verificarPatente();
                document.getElementById("inputPatente").value = "";
            } catch (e) { alert("Error al guardar"); }
        }
    </script>
</body>
</html>
